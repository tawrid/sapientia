<!-- public/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Info Collector</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
    <h1>Client Information Collection</h1>
    <p id="status">Collecting information...</p>

    <script>
        $(document).ready(function() {
            // Step 1: Fetch API keys and system username from the backend
            $.get('/config', function(config) {
                const { opencageApiKey, ipinfoToken, systemUsername } = config;

                // Check if necessary tokens are received
                if (!opencageApiKey || !ipinfoToken) {
                    $('#status').text('Missing API configuration.');
                    console.error('Missing required API keys in config.');
                    return;
                }

                // Step 2: Collect client info from browser
                const userAgent = navigator.userAgent;
                const platform = navigator.platform;

                // Step 3: Get IP and GEO data from ipinfo
                $.get(`https://ipinfo.io?token=${ipinfoToken}`, function(response) {
                    const ip = response.ip;
                    const [latitude, longitude] = response.loc.split(",");
                    
                    // Log the IP and coordinates for debugging
                    console.log('Client IP:', ip);
                    console.log('Latitude:', latitude, 'Longitude:', longitude);

                    // Step 4: Use OpenCage API to get location details
                    $.get(`https://api.opencagedata.com/geocode/v1/json?q=${latitude}+${longitude}&key=${opencageApiKey}`, function(geoResponse) {
                        const geoData = geoResponse.results[0]?.components || {};
                        const locationDetails = {
                            suburb: geoData.suburb || "N/A",
                            city: geoData.city || geoData.town || geoData.village || "N/A",
                            state: geoData.state || "N/A",
                            country: geoData.country || "N/A"
                        };

                        // Log location details for debugging
                        console.log('Location Details:', locationDetails);

                        // Step 5: Prepare data to send, including server-provided username
                        const data = {
                            username: systemUsername,
                            userAgent: userAgent,
                            platform: platform,
                            ip: ip,
                            geo: locationDetails
                        };

                        // Step 6: Send collected data to the backend server
                        $.ajax({
                            url: '/collect',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(data),
                            success: function() {
                                $('#status').text('Information submitted successfully!');
                                console.log('Data submitted:', data);
                            },
                            error: function(err) {
                                $('#status').text('Error submitting information.');
                                console.error('Error in submission:', err);
                            }
                        });
                    }).fail(function(err) {
                        $('#status').text('Error retrieving geolocation data.');
                        console.error('Error with OpenCage API:', err);
                    });
                }).fail(function(err) {
                    $('#status').text('Error retrieving IP information.');
                    console.error('Error with ipinfo API:', err);
                });
            }).fail(function(err) {
                $('#status').text('Error fetching configuration.');
                console.error('Error fetching /config:', err);
            });
        });
    </script>
</body>
</html>
